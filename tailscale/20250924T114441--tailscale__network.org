#+title:      tailscale
#+date:       [2025-09-24 Wed 11:44]
#+filetags:   :network:
#+identifier: 20250924T114441

* tangle
#+begin_src elisp
(zr-org-babel-json-format "acl-rules")
(let ((zr-local-pls (plstore-open "tailscale.pls")))
  (org-babel-tangle))
#+end_src

* acl
:PROPERTIES:
:CUSTOM_ID: 01deabc9-1e59-4dd2-a2a3-9aadcf7e9e30
:END:
#+name: acl-rules
#+header: :var main_owner=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "owner")) :name)) 1 -1)
#+begin_src json :mkdirp t :tangle (zr-org-by-tangle-dir "acl.json")
{
  "grants": [
    {
      "dst": [
        "tag:home"
      ],
      "ip": [
        "tcp:22"
      ],
      "src": [
        "tag:com"
      ],
      "srcPosture": [
        "posture:com"
      ]
    },
    {
      "dst": [
        "tag:home",
        "tag:phone",
        "tag:vps",
        "autogroup:internet",
        "$main_owner"
      ],
      "ip": [
        "*"
      ],
      "src": [
        "tag:home",
        "tag:phone"
      ]
    }
  ],
  "postures": {
    "posture:com": [
      "node:os IN ['windows']",
      "node:osVersion >= '10.0.26100.4946'",
      "node:tsVersion >= 'sing-box 1.12.12'",
      "node:tsAutoUpdate == false"
    ]
  },
  "tagOwners": {
    "tag:com": [
      "$main_owner"
    ],
    "tag:home": [
      "$main_owner"
    ],
    "tag:phone": [
      "$main_owner"
    ],
    "tag:vps": [
      "$main_owner"
    ]
  },
  "tests": [
    {
      "accept": [
        "tag:home:22"
      ],
      "deny": [
        "tag:home:80",
        "tag:phone:80",
        "tag:vps:80",
        "$main_owner:80"
      ],
      "proto": "tcp",
      "src": "tag:com",
      "srcPostureAttrs": {
        "node:os": "windows",
        "node:osVersion": "10.0.26100.4946",
        "node:tsAutoUpdate": false,
        "node:tsVersion": "sing-box 1.12.12"
      }
    },
    {
      "deny": [
        "tag:home:80",
        "tag:phone:80",
        "tag:com:80",
        "$main_owner:80"
      ],
      "src": "tag:vps"
    },
    {
      "accept": [
        "tag:home:80",
        "tag:phone:80",
        "tag:vps:80",
        "$main_owner:80"
      ],
      "deny": [
        "tag:com:80"
      ],
      "src": "tag:home"
    },
    {
      "accept": [
        "tag:home:80",
        "tag:phone:80",
        "tag:vps:80",
        "$main_owner:80"
      ],
      "deny": [
        "tag:com:80"
      ],
      "src": "tag:phone"
    }
  ]
}
#+end_src
