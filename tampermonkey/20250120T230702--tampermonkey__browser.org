#+title:      tampermonkey
#+date:       [2025-01-20 Mon 23:07]
#+filetags:   :browser:
#+identifier: 20250120T230702
#+property: header-args:org :comments no

* tangle
#+begin_src elisp
(let ((zr-local-pls (car (auth-source-search
                          :host "aria2.remote"))))
  (org-babel-tangle))
#+end_src

* scripts

** cookies-dumper
:PROPERTIES:
:header-args: :tangle (zr-org-by-tangle-dir "cookies-dumper.js") :mkdirp t
:CUSTOM_ID: 6fc870b6-bae2-4b60-8858-5e2af52b8cfa
:END:

#+begin_src org :var path=(zr-org-by-tangle-dir "cookies-dumper.js")
// ==UserScript==
// @name         Cookies-dumper
// @namespace    http://tampermonkey.net/
// @version      2024-10-27
// @description  Push cookies to emacs.
// @author       kkky
// @icon         https://www.google.com/s2/favicons?sz=64&domain=bilibili.com
// @grant        GM_cookie
// @require      file:///$path
// ==/UserScript==
#+end_src

#+begin_src js
function dumpCookiesInNetscapeFormat(cookies) {
  let netscapeCookies = [
    '# Netscape HTTP Cookie File'
    // '# This file was generated by Tampermonkey! Edit at your own risk.',
    // '',
    // '# Domain    True    Path    False    Expiration    Name    Value'
  ];

  let neededCookies;

  let hostname = location.hostname;
  if (hostname.endsWith('.bilibili.com'))
    neededCookies = ['SESSDATA'];
  else if (hostname.endsWith('.youtube.com'))
    neededCookies = ['__Secure-1PAPISID', '__Secure-3PAPISID', '__Secure-1PSID', '__Secure-1PSIDTS'];
  else
    neededCookies = '_any';

  cookies.forEach(({ domain, hostOnly, path, secure, expirationDate, name, value }) => {

    if (neededCookies === '_any' ||  neededCookies.includes(name)){
      // Format the line
      const netscapeCookie = `${domain}\t${ hostOnly ? "FALSE" : "TRUE" }\t${path}\t${secure ? "TRUE" : "FALSE"}\t${expirationDate >> 0}\t${name}\t${value}`;
      netscapeCookies.push(netscapeCookie);
    }
  });

  return netscapeCookies.join('\n');
}

function pushToEmacs(text){
  const domainParts = location.hostname.split('.');
  let domains;
  if (domainParts.at(-2) === 'com')
    domains = domainParts.slice(-3);
  else
    domains = domainParts.slice(-2);

  // Construct the custom org-protocol URL
  const orgProtocolURL = 'org-protocol://cookies-dumper?' + 
        new URLSearchParams({
          host: domains.join('.'),
          cookies: text
        });

  // Create a temporary link element
  const link = document.createElement('a');
  link.href = orgProtocolURL;

  // Trigger the link to open
  link.click();

  link.remove();
  
}

GM_cookie.list({}, function(cookies, error) {
  if (!error) {
    pushToEmacs(dumpCookiesInNetscapeFormat(cookies));
  } else {
    console.error(error);
  }
});
#+end_src

** File List
:PROPERTIES:
:header-args: :var aria2_remote_token=(auth-info-password zr-local-pls) aria2_remote_url=(plist-get zr-local-pls :user)
:CUSTOM_ID: 17fa8862-9243-4d50-b8a6-62e04976a848
:END:

*** baidu
:PROPERTIES:
:header-args+: :tangle (zr-org-by-tangle-dir "file-list.js") :mkdirp t
:CUSTOM_ID: 448afd5a-4d4c-4a08-b668-610654d0c781
:END:
#+begin_src js 
// ==UserScript==
// @name         File List
// @namespace    http://tampermonkey.net/
// @version      2025-08-06
// @description  try to take over the world!
// @author       DeepSeek
// @match        https://yyzz.426720.xyz/
// @icon         https://www.google.com/s2/favicons?sz=64&domain=426720.xyz
// @grant        GM_xmlhttpRequest
// ==/UserScript==

(function() {
  'use strict';

  // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
  setTimeout(function() {
    // æ‰¾åˆ°æ‰¹é‡å‘é€ä¸‹è½½æŒ‰é’®çš„å®¹å™¨
    const sendButton = document.getElementById('send-selected-button');

    if (!sendButton) return;

    // åˆ›å»ºæ–°æŒ‰é’®
    const newButton = document.createElement('button');
    newButton.id = 'custom-download-button';
    newButton.textContent = 'è‡ªå®šä¹‰ä¸‹è½½';
    newButton.style.marginLeft = '10px';
    newButton.style.backgroundColor = '#6c757d'; // ç°è‰²æŒ‰é’®
    newButton.style.color = 'white';
    newButton.style.border = 'none';
    newButton.style.borderRadius = '5px';
    newButton.style.padding = '8px 16px';
    newButton.style.cursor = 'pointer';
    newButton.style.fontSize = '14px';

    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
    newButton.addEventListener('click', function() {
      customDownloadFunction();
    });

    // å°†æ–°æŒ‰é’®æ’å…¥åˆ°å‘é€æŒ‰é’®åé¢
    sendButton.parentNode.insertBefore(newButton, sendButton.nextSibling);

  }, 1000);

  // è·å–é€‰ä¸­çš„æ–‡ä»¶è·¯å¾„ï¼ˆå¤ç”¨é¡µé¢åŸæœ‰å‡½æ•°ï¼‰
  function getSelectedFiles() {
    const selectedFiles = [];
    const fileCheckboxes = document.querySelectorAll('.file-checkbox:checked');

    fileCheckboxes.forEach(checkbox => {
      selectedFiles.push(checkbox.getAttribute('data-path'));
    });

    return selectedFiles;
  }

  async function myPushToAria2(rawUrl) {
    try {
      const aria2Payload = {
        jsonrpc: '2.0',
        method: 'aria2.addUri',
        id: '1',
        params: [
          `token:${aria2_remote_token}`,
          [rawUrl],
          {
            header: ["User-Agent: pan.baidu.com"]
          }
        ]
      };

      GM_xmlhttpRequest({
        method: "POST",
        url: aria2_remote_url,
        headers: {
          "Content-Type": "application/json"
        },
        data: JSON.stringify(aria2Payload),
        onload: function(response) {
          const aria2Data = JSON.parse(response.responseText);
          console.log('Aria2 å“åº”:', aria2Data);

          if (aria2Data.result) {
            showCustomAlert(`ä¸‹è½½ä»»åŠ¡å·²æˆåŠŸæ·»åŠ åˆ° Aria2ï¼`);
          } else {
            console.error(`æ·»åŠ ä¸‹è½½ä»»åŠ¡å¤±è´¥:`, aria2Data.error);
            alert(`æ·»åŠ ä¸‹è½½ä»»åŠ¡å¤±è´¥`);
          }
        },
        onerror: function(error) {
          console.error(`è¯·æ±‚ Aria2 RPC å¤±è´¥:`, error);
          alert(`è¯·æ±‚ Aria2 RPC å¤±è´¥ï¼`);
        }
      });
    } catch (error) {
      console.error(`å¤„ç†è¯·æ±‚æ—¶å‡ºé”™:`, error);
      alert(`å¤„ç†è¯·æ±‚æ—¶å‡ºé”™ï¼`);
    }
  }

  // è‡ªå®šä¹‰ä¸‹è½½å‡½æ•°
  async function customDownloadFunction() {
    const selectedFiles = getSelectedFiles();
    if (selectedFiles.length === 0) {
      alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶ï¼');
      return;
    }

    console.log('è‡ªå®šä¹‰ä¸‹è½½åŠŸèƒ½è¢«è°ƒç”¨ï¼Œé€‰ä¸­çš„æ–‡ä»¶:', selectedFiles);

    // è¿™é‡Œå¯ä»¥æ·»åŠ ä½ çš„è‡ªå®šä¹‰ä¸‹è½½é€»è¾‘
    // ä¾‹å¦‚ï¼š
    try {
      // 1. è·å–æ–‡ä»¶ä¸‹è½½é“¾æ¥
      const response = await fetch('cun/dlinklist.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json;charset=UTF-8',
        },
        body: JSON.stringify({
          paths: selectedFiles
        })
      });

      const data = await response.json();

      if (Array.isArray(data)) {
        // 2. å¤„ç†æ¯ä¸ªä¸‹è½½é“¾æ¥
        for (const item of data) {
          if (item.raw_url) {
            const url = item.raw_url.replace(/^http:\/\//, 'https://');
            console.log('å¤„ç†æ–‡ä»¶:', url);

            // è¿™é‡Œå¯ä»¥è°ƒç”¨ä½ çš„è‡ªå®šä¹‰ä¸‹è½½é€»è¾‘
            await myPushToAria2(url);
          }
        }

        alert(`å·²å¤„ç† ${data.length} ä¸ªæ–‡ä»¶`);
      } else {
        alert('è·å–ä¸‹è½½é“¾æ¥å¤±è´¥');
      }
    } catch (error) {
      console.error('è‡ªå®šä¹‰ä¸‹è½½å‡ºé”™:', error);
      alert('ä¸‹è½½å‡ºé”™: ' + error.message);
    }
  }
})();
#+end_src

*** ali
:PROPERTIES:
:header-args+: :tangle (zr-org-by-tangle-dir "file-list-ali.js") :mkdirp t
:CUSTOM_ID: b8b171e3-babe-4442-bdcb-777f4cb31bab
:END:
#+begin_src js
// ==UserScript==
// @name         é˜¿é‡Œäº‘ç›˜ç½‘é¡µç‰ˆ â€“ æ¨é€åˆ° aria2
// @namespace    http://tampermonkey.net/
// @version      2025-09-21
// @author       You
// @match        https://bw.01233.xyz/alipan/
// @icon         https://www.google.com/s2/favicons?sz=64&domain=01233.xyz
// @description  åŠ«æŒç½‘é¡µå†…â€œæ¨é€åˆ° Motrixâ€æŒ‰é’®ï¼ŒæŠŠ RPC å‘åˆ°è‡ªå®šä¹‰åœ°å€å¹¶è‡ªå®šä¹‰å‚æ•°
// @grant        GM_xmlhttpRequest
// @run-at       document-start
// ==/UserScript==

(function () {
    'use strict';

    // ç­‰å¾…é¡µé¢è„šæœ¬å®šä¹‰å®Œ pushToMotrix åï¼Œç«‹å³è¦†ç›–
    function override() {
        if (typeof unsafeWindow.pushToMotrix !== 'function') {
            setTimeout(override, 0);
            return;
        }
        unsafeWindow.pushToMotrix = function (downloadUrl, outFileNameWithPath) {
            const params = aria2_remote_token
                ? [`token:${aria2_remote_token}`, [downloadUrl], { out: outFileNameWithPath }]
                : [[downloadUrl], { out: outFileNameWithPath }];

            const payload = {
                jsonrpc: '2.0',
                method : 'aria2.addUri',
                id     : Date.now().toString(),
                params
            };

            GM_xmlhttpRequest({
                method : 'POST',
                url    : aria2_remote_url,
                headers: { 'Content-Type': 'application/json' },
                data   : JSON.stringify(payload),
                onload(r) {
                    const res = JSON.parse(r.responseText);
                    if (res.result) {
                        console.log('æ¨é€æˆåŠŸï¼š', outFileNameWithPath);
                    } else {
                        console.warn('æ¨é€å¤±è´¥ï¼š', outFileNameWithPath, res);
                    }
                },
                onerror(err) {
                    console.error('è¿æ¥ Motrix å‡ºé”™ï¼š', err);
                }
            });
        };
    }
    override();
})();
#+end_src

** qr-decoder
:PROPERTIES:
:CUSTOM_ID: f6c588d9-ad10-4bee-9609-112e1f1aae4a
:END:
#+begin_src js :tangle (zr-org-by-tangle-dir "qr-decoder.js")
// ==UserScript==
// @name         äºŒç»´ç è§£ç å™¨
// @namespace    http://tampermonkey.net/
// @version      1.2
// @description  å³é”®å›¾ç‰‡è§£ç äºŒç»´ç ï¼Œæ”¯æŒæ‰“å¼€é“¾æ¥ã€å¤åˆ¶æ–‡æœ¬ï¼Œæ”¯æŒ Data URLã€å‰ªè´´æ¿å’Œå†å²è®°å½•
// @author       Claude
// @match        *://*/*
// @grant        GM_setClipboard
// @grant        GM_openInTab
// @grant        GM_addStyle
// @grant        GM_notification
// @grant        GM_registerMenuCommand
// @grant        GM_unregisterMenuCommand
// @grant        GM_setValue
// @grant        GM_getValue
// @require      https://fastly.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js
// @license      MIT
// ==/UserScript==

(function() {
  'use strict';

  // æ·»åŠ æ ·å¼
  GM_addStyle(`
        .qr-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100000;
        }
        
        .qr-modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .qr-result-text {
            margin: 15px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .qr-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .qr-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .qr-btn-primary {
            background: #007bff;
            color: white;
        }
        
        .qr-btn-primary:hover {
            background: #0056b3;
        }
        
        .qr-btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .qr-btn-secondary:hover {
            background: #545b62;
        }
        
        .qr-loading {
            text-align: center;
            padding: 20px;
        }
        
        .qr-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .qr-shortcut-hint {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }
        
        .qr-history-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100001;
        }
        
        .qr-history-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }
        
        .qr-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .qr-history-list {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        
        .qr-history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .qr-history-item:hover {
            background: #f5f5f5;
        }
        
        .qr-history-item:last-child {
            border-bottom: none;
        }
        
        .qr-history-time {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .qr-history-text {
            word-break: break-all;
            margin-bottom: 5px;
        }
        
        .qr-history-actions {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
        
        .qr-history-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .qr-history-btn-open {
            background: #007bff;
            color: white;
        }
        
        .qr-history-btn-copy {
            background: #28a745;
            color: white;
        }
        
        .qr-empty-history {
            text-align: center;
            color: #666;
            padding: 40px;
        }
    `);

  let menuCommandId = null;
  let clipboardCommandId = null;
  let historyCommandId = null;

  // åˆ›å»ºæ¨¡æ€æ¡†
  const modal = document.createElement('div');
  modal.className = 'qr-modal';
  modal.innerHTML = `
        <div class="qr-modal-content">
            <h3>äºŒç»´ç è§£ç ç»“æœ</h3>
            <div id="qr-result-container">
                <div class="qr-loading">
                    <div class="qr-spinner"></div>
                    <p>æ­£åœ¨è§£ç ...</p>
                </div>
            </div>
            <div class="qr-buttons" id="qr-buttons" style="display: none;">
                <button class="qr-btn qr-btn-primary" id="qr-open-btn" style="display: none;">æ‰“å¼€</button>
                <button class="qr-btn qr-btn-secondary" id="qr-copy-btn">å¤åˆ¶</button>
                <button class="qr-btn qr-btn-secondary" id="qr-cancel-btn">å–æ¶ˆ</button>
            </div>
            <div class="qr-shortcut-hint">
                Enter: æ‰“å¼€ | Ctrl+C: å¤åˆ¶ | Esc: å–æ¶ˆ
            </div>
        </div>
    `;
  document.body.appendChild(modal);

  // åˆ›å»ºå†å²è®°å½•æ¨¡æ€æ¡†
  const historyModal = document.createElement('div');
  historyModal.className = 'qr-history-modal';
  historyModal.innerHTML = `
        <div class="qr-history-content">
            <div class="qr-history-header">
                <h3>è§£ç å†å²è®°å½•</h3>
                <button class="qr-btn qr-btn-secondary" id="qr-history-close-btn">å…³é—­</button>
            </div>
            <div id="qr-history-list" class="qr-history-list">
                <div class="qr-empty-history">æš‚æ— å†å²è®°å½•</div>
            </div>
        </div>
    `;
  document.body.appendChild(historyModal);

  let currentImage = null;
  let qrResult = null;

  // æ£€æµ‹é¼ æ ‡æ‚¬åœçš„å…ƒç´ 
  let hoveredElement = null;
  
  // æ³¨å†Œå…¨å±€èœå•é¡¹
  clipboardCommandId = GM_registerMenuCommand('ğŸ“‹ ä»å‰ªè´´æ¿è§£ç äºŒç»´ç ', function() {
    modal.style.display = 'flex';
    decodeFromClipboard();
  });
  
  // æ³¨å†Œå†å²è®°å½•èœå•é¡¹
  historyCommandId = GM_registerMenuCommand('ğŸ“š æŸ¥çœ‹è§£ç å†å²', function() {
    showHistory();
  });
  
  // ç›‘å¬å³é”®èœå•
  document.addEventListener('contextmenu', function(e) {
    const target = e.target;
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡å…ƒç´ 
    const isImage = target.tagName === 'IMG' || 
          (target.style && target.style.backgroundImage && 
           target.style.backgroundImage !== 'none') ||
          (target.tagName === 'CANVAS');
    
    if (isImage) {
      // ä¿å­˜å½“å‰å³é”®çš„å›¾ç‰‡å…ƒç´ 
      window.qrScannerRightClickedElement = target;
    } else {
      window.qrScannerRightClickedElement = null;
    }
  });
  
  // æ³¨å†Œå›¾ç‰‡å³é”®èœå•
  menuCommandId = GM_registerMenuCommand('ğŸ” è§£ç å›¾ç‰‡äºŒç»´ç ', function() {
    if (window.qrScannerRightClickedElement) {
      currentImage = window.qrScannerRightClickedElement;
      modal.style.display = 'flex';
      decodeQRCode();
    } else {
      GM_notification({
        title: 'äºŒç»´ç è§£ç å™¨',
        text: 'è¯·å…ˆåœ¨å›¾ç‰‡ä¸Šå³é”®',
        timeout: 2000
      });
    }
  });

  // è§£ç äºŒç»´ç 
  function decodeQRCode() {
    const resultContainer = document.getElementById('qr-result-container');
    const buttons = document.getElementById('qr-buttons');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    resultContainer.innerHTML = `
            <div class="qr-loading">
                <div class="qr-spinner"></div>
                <p>æ­£åœ¨è§£ç ...</p>
            </div>
        `;
    buttons.style.display = 'none';

    // è·å–å›¾ç‰‡
    let imgSrc;
    if (currentImage.tagName === 'IMG') {
      imgSrc = currentImage.src;
    } else if (currentImage.tagName === 'CANVAS') {
      // Canvas å…ƒç´ 
      imgSrc = currentImage.toDataURL();
    } else {
      // èƒŒæ™¯å›¾ç‰‡
      const bgImage = currentImage.style.backgroundImage;
      imgSrc = bgImage.slice(5, -2); // å»æ‰ url(" å’Œ ")
    }

    // åˆ›å»º canvas æ¥å¤„ç†å›¾ç‰‡
    const img = new Image();
    img.crossOrigin = 'anonymous';
    
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      
      if (code) {
        qrResult = code.data;
        showResult(code.data);
      } else {
        showError('æœªèƒ½æ£€æµ‹åˆ°äºŒç»´ç ');
      }
    };
    
    img.onerror = function() {
      showError('å›¾ç‰‡åŠ è½½å¤±è´¥');
    };
    
    img.src = imgSrc;
  }
  
  // ä»å‰ªè´´æ¿è§£ç 
  function decodeFromClipboard() {
    const resultContainer = document.getElementById('qr-result-container');
    const buttons = document.getElementById('qr-buttons');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    resultContainer.innerHTML = `
            <div class="qr-loading">
                <div class="qr-spinner"></div>
                <p>æ­£åœ¨è¯»å–å‰ªè´´æ¿...</p>
            </div>
        `;
    buttons.style.display = 'none';
    
    // å°è¯•è¯»å–å‰ªè´´æ¿
    navigator.clipboard.read().then(items => {
      for (const item of items) {
        const imageTypes = item.types.filter(type => type.startsWith('image/'));
        if (imageTypes.length > 0) {
          const imageType = imageTypes[0];
          item.getType(imageType).then(blob => {
            const reader = new FileReader();
            reader.onload = function(e) {
              const img = new Image();
              img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                  qrResult = code.data;
                  showResult(code.data);
                } else {
                  showError('å‰ªè´´æ¿å›¾ç‰‡ä¸­æœªæ£€æµ‹åˆ°äºŒç»´ç ');
                }
              };
              img.onerror = function() {
                showError('å‰ªè´´æ¿å›¾ç‰‡åŠ è½½å¤±è´¥');
              };
              img.src = e.target.result;
            };
            reader.readAsDataURL(blob);
          }).catch(() => {
            showError('è¯»å–å‰ªè´´æ¿å›¾ç‰‡å¤±è´¥');
          });
          return;
        }
      }
      // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡æœ¬å†…å®¹ï¼ˆå¯èƒ½æ˜¯ Data URLï¼‰
      navigator.clipboard.readText().then(text => {
        if (text.startsWith('data:image/')) {
          // æ˜¯ Data URL
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            if (code) {
              qrResult = code.data;
              showResult(code.data);
            } else {
              showError('å‰ªè´´æ¿ Data URL ä¸­æœªæ£€æµ‹åˆ°äºŒç»´ç ');
            }
          };
          img.onerror = function() {
            showError('å‰ªè´´æ¿ Data URL åŠ è½½å¤±è´¥');
          };
          img.src = text;
        } else {
          showError('å‰ªè´´æ¿ä¸­æ²¡æœ‰å›¾ç‰‡æˆ– Data URL');
        }
      }).catch(() => {
        showError('è¯»å–å‰ªè´´æ¿æ–‡æœ¬å¤±è´¥');
      });
    }).catch(() => {
      // å¦‚æœæ— æ³•è¯»å–å‰ªè´´æ¿ï¼Œæç¤ºç”¨æˆ·
      resultContainer.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <p>æ— æ³•è®¿é—®å‰ªè´´æ¿ï¼Œè¯·ç¡®ä¿ï¼š</p>
                    <p>1. æµè§ˆå™¨æ”¯æŒå‰ªè´´æ¿ API</p>
                    <p>2. å·²æˆäºˆå‰ªè´´æ¿è¯»å–æƒé™</p>
                    <p>3. å‰ªè´´æ¿ä¸­æœ‰å›¾ç‰‡å†…å®¹</p>
                </div>
            `;
      buttons.style.display = 'flex';
      document.getElementById('qr-open-btn').style.display = 'none';
    });
  }

  // ä¿å­˜å†å²è®°å½•
  function saveHistory(result) {
    try {
      let history = GM_getValue('qrHistory', []);
      const historyItem = {
        id: Date.now(),
        result: result,
        timestamp: new Date().toISOString(),
        isUrl: isValidUrl(result)
      };
      
      // æ·»åŠ åˆ°å†å²è®°å½•å¼€å¤´
      history.unshift(historyItem);
      
      // é™åˆ¶å†å²è®°å½•æ•°é‡ï¼ˆæœ€å¤š50æ¡ï¼‰
      if (history.length > 50) {
        history = history.slice(0, 50);
      }
      
      GM_setValue('qrHistory', history);
    } catch (e) {
      console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
    }
  }

  // æ˜¾ç¤ºå†å²è®°å½•
  function showHistory() {
    const historyList = document.getElementById('qr-history-list');
    let history = [];
    
    try {
      history = GM_getValue('qrHistory', []);
    } catch (e) {
      console.error('è¯»å–å†å²è®°å½•å¤±è´¥:', e);
    }
    
    if (history.length === 0) {
      historyList.innerHTML = '<div class="qr-empty-history">æš‚æ— å†å²è®°å½•</div>';
    } else {
      historyList.innerHTML = history.map(item => `
                <div class="qr-history-item" data-id="${item.id}">
                    <div class="qr-history-time">${formatTime(item.timestamp)}</div>
                    <div class="qr-history-text">${escapeHtml(item.result)}</div>
                    <div class="qr-history-actions">
                        ${item.isUrl ? `<button class="qr-history-btn qr-history-btn-open" data-result="${escapeHtml(item.result)}">æ‰“å¼€</button>` : ''}
                        <button class="qr-history-btn qr-history-btn-copy" data-result="${escapeHtml(item.result)}">å¤åˆ¶</button>
                    </div>
                </div>
            `).join('');
      
      // æ·»åŠ äº‹ä»¶ç›‘å¬
      historyList.querySelectorAll('.qr-history-btn-open').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const result = this.getAttribute('data-result');
          GM_openInTab(result, { active: true });
        });
      });
      
      historyList.querySelectorAll('.qr-history-btn-copy').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const result = this.getAttribute('data-result');
          GM_setClipboard(result);
          GM_notification({
            title: 'äºŒç»´ç è§£ç å™¨',
            text: 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
            timeout: 2000
          });
        });
      });
    }
    
    historyModal.style.display = 'flex';
  }

  // æ ¼å¼åŒ–æ—¶é—´
  function formatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) {
      return 'åˆšåˆš';
    } else if (diff < 3600000) {
      return Math.floor(diff / 60000) + ' åˆ†é’Ÿå‰';
    } else if (diff < 86400000) {
      return Math.floor(diff / 3600000) + ' å°æ—¶å‰';
    } else {
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }
  }

  // æ˜¾ç¤ºç»“æœ
  function showResult(result) {
    const resultContainer = document.getElementById('qr-result-container');
    const buttons = document.getElementById('qr-buttons');
    const openBtn = document.getElementById('qr-open-btn');
    
    resultContainer.innerHTML = `<div class="qr-result-text">${escapeHtml(result)}</div>`;
    buttons.style.display = 'flex';
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ URL
    if (isValidUrl(result)) {
      openBtn.style.display = 'inline-block';
    } else {
      openBtn.style.display = 'none';
    }
    
    // ä¿å­˜åˆ°å†å²è®°å½•
    saveHistory(result);
  }

  // æ˜¾ç¤ºé”™è¯¯
  function showError(message) {
    const resultContainer = document.getElementById('qr-result-container');
    const buttons = document.getElementById('qr-buttons');
    
    resultContainer.innerHTML = `<p style="color: red; text-align: center;">${message}</p>`;
    buttons.style.display = 'flex';
    document.getElementById('qr-open-btn').style.display = 'none';
  }

  // HTML è½¬ä¹‰
  function escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
  }

  // éªŒè¯ URL
  function isValidUrl(string) {
    try {
      new URL(string);
      return true;
    } catch (_) {
      return false;
    }
  }

  // æŒ‰é’®äº‹ä»¶
  document.getElementById('qr-open-btn').addEventListener('click', function() {
    if (qrResult && isValidUrl(qrResult)) {
      GM_openInTab(qrResult, { active: true });
      closeModal();
    }
  });

  document.getElementById('qr-copy-btn').addEventListener('click', function() {
    if (qrResult) {
      GM_setClipboard(qrResult);
      GM_notification({
        title: 'äºŒç»´ç è§£ç å™¨',
        text: 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
        timeout: 2000
      });
    }
  });

  document.getElementById('qr-cancel-btn').addEventListener('click', closeModal);

  // å…³é—­æ¨¡æ€æ¡†
  function closeModal() {
    modal.style.display = 'none';
    qrResult = null;
  }

  
  // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeModal();
    }
  });

  // å†å²è®°å½•å…³é—­æŒ‰é’®
  document.getElementById('qr-history-close-btn').addEventListener('click', function() {
    historyModal.style.display = 'none';
  });

  // ç‚¹å‡»å†å²è®°å½•æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
  historyModal.addEventListener('click', function(e) {
    if (e.target === historyModal) {
      historyModal.style.display = 'none';
    }
  });

  // é”®ç›˜å¿«æ·é”®
  document.addEventListener('keydown', function(e) {
    // ä¸»æ¨¡æ€æ¡†å¿«æ·é”®
    if (modal.style.display === 'flex') {
      if (e.key === 'Escape') {
        closeModal();
      } else if (e.ctrlKey && e.key === 'c') {
        e.preventDefault();
        document.getElementById('qr-copy-btn').click();
      } else if (e.key === 'Enter' && qrResult && isValidUrl(qrResult)) {
        e.preventDefault();
        document.getElementById('qr-open-btn').click();
      }
    }
    // å†å²è®°å½•æ¨¡æ€æ¡†å¿«æ·é”®
    else if (historyModal.style.display === 'flex') {
      if (e.key === 'Escape') {
        historyModal.style.display = 'none';
      }
    }
  });

})();
#+end_src
