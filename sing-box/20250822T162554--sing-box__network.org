#+title:      sing-box
#+date:       [2025-08-22 Fri 16:25]
#+filetags:   :network:
#+identifier: 20250822T162554

* tangle
#+begin_src elisp
(dolist (c '("client-config"
             "server-config"
             "android-tun"))
  (zr-org-babel-json-format c))
(let* ((zr-local-pls (plstore-open "sing-box.pls"))
       (client-dir "_tangle/client/")
       (tun-dir (expand-file-name "tun/" client-dir))
       (merge-file (expand-file-name "_500-merge.json" client-dir))
       (delete-by-moving-to-trash))
  (delete-directory "_tangle" t)
  (org-babel-tangle)
  (mkdir tun-dir t)
  (call-process "sing-box" nil nil nil "merge"
                merge-file "-C" "_tangle/tmp/")
  (dolist (f (directory-files "." t "^_.+\\.json$" t))
    (make-symbolic-link f tun-dir t)
    (make-symbolic-link f client-dir t))
  (make-symbolic-link merge-file tun-dir t)

  (when-let* ((android-dir (and (eq system-type 'android)
                                "/storage/emulated/0/sing-box/")))
    (mkdir android-dir t)
    (dolist (c `(("main.json" . ,client-dir)
                 ("tun.json" . ,tun-dir)))
      (call-process "sing-box" nil nil nil "merge"
                    (expand-file-name (car c) android-dir)
                    "-C" (cdr c))))
  (plstore-close zr-local-pls))
#+end_src

* config
:PROPERTIES:
:CUSTOM_ID: 3aeea361-850d-4cc8-b292-065568c194d3
:header-args:json: :var hy_obfs_pass=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "hy")) :obfs-pass)) 1 -1)
:header-args:json+: :var hy_user_pass=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "hy")) :user-pass)) 1 -1)
:header-args:json+: :var hy_host=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "hy")) :host)) 1 -1)
:header-args:json+: :var vl_host=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "vl")) :host)) 1 -1)
:header-args:json+: :var vl_short_id=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "vl")) :short-id)) 1 -1)
:header-args:json+: :var vl_user_uuid=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "vl")) :user-uuid)) 1 -1)
:header-args:json+: :var any_host=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "any")) :host)) 1 -1)
:header-args:json+: :var any_pass=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "any")) :pass)) 1 -1)
:END:

** client
:PROPERTIES:
:tangle-dir: _tangle/tmp
:CUSTOM_ID: 4acfcf10-2bef-4815-af7a-fd5f0271c77f
:END:

*** main
:PROPERTIES:
:CUSTOM_ID: fed30130-cdf9-42cb-805c-50dbb7b4c5bf
:END:
#+header: :var hy_ip=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "hy")) :ip)) 1 -1)
#+header: :var vl_ip=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "vl")) :ip)) 1 -1)
#+header: :var vl_pub_key=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "vl")) :pub-key)) 1 -1)
#+header: :var any_ip=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "any")) :ip)) 1 -1)
#+header: :var jsdelivr="https://fastly.jsdelivr.net"
#+name: client-config
#+begin_src json :tangle (zr-org-by-tangle-dir "500-main.json") :mkdirp t
{
  "dns": {
    "final": "google",
    "rules": [
      {
        "ip_accept_any": true,
        "server": "hosts-in"
      },
      {
        "rule_set": "geosite-cn",
        "server": "dns_alidns_doh_ip"
      }
    ],
    "servers": [
      {
        "detour": "auto",
        "server": "8.8.8.8",
        "tag": "google",
        "type": "tls"
      },
      {
        "server": "223.5.5.5",
        "server_port": 443,
        "tag": "dns_alidns_doh_ip",
        "type": "https"
      }
    ],
    "strategy": "ipv4_only"
  },
  "inbounds": [
    {
      "listen_port": 10805,
      "set_system_proxy": false,
      "tag": "mixed-in",
      "type": "mixed"
    }
  ],
  "log": {
    "level": "warn"
  },
  "outbounds": [
    {
      "tag": "direct",
      "type": "direct"
    },
    {
      "interrupt_exist_connections": false,
      "outbounds": [
        "any",
        "vl",
        "hy"
      ],
      "tag": "auto",
      "type": "urltest"
    },
    {
      "flow": "xtls-rprx-vision",
      "server": "$vl_ip",
      "server_port": 38199,
      "tag": "vl",
      "tls": {
        "enabled": true,
        "reality": {
          "enabled": true,
          "public_key": "$vl_pub_key",
          "short_id": "$vl_short_id"
        },
        "server_name": "$vl_host",
        "utls": {
          "enabled": true
        }
      },
      "type": "vless",
      "uuid": "$vl_user_uuid"
    },
    {
      "password": "$any_pass",
      "server": "$any_ip",
      "server_port": 39833,
      "tag": "any",
      "tls": {
        "enabled": true,
        "server_name": "$any_host"
      },
      "type": "anytls"
    },
    {
      "obfs": {
        "password": "$hy_obfs_pass",
        "type": "salamander"
      },
      "password": "$hy_user_pass",
      "server": "$hy_ip",
      "server_port": 30104,
      "tag": "hy",
      "tls": {
        "alpn": [
          "h3"
        ],
        "enabled": true,
        "server_name": "$hy_host"
      },
      "type": "hysteria2"
    }
  ],
  "route": {
    "auto_detect_interface": true,
    "default_domain_resolver": {
      "server": "google"
    },
    "final": "auto",
    "rule_set": [
      {
        "format": "binary",
        "tag": "geoip-cn",
        "type": "remote",
        "url": "$jsdelivr/gh/chocolate4u/Iran-sing-box-rules@rule-set/geoip-cn.srs"
      },
      {
        "format": "binary",
        "tag": "geosite-cn",
        "type": "remote",
        "url": "$jsdelivr/gh/chocolate4u/Iran-sing-box-rules@rule-set/geosite-cn.srs"
      },
      {
        "format": "binary",
        "tag": "geoip-cloudflare",
        "type": "remote",
        "url": "$jsdelivr/gh/chocolate4u/Iran-sing-box-rules@rule-set/geoip-cloudflare.srs"
      }
    ],
    "rules": [
      {
        "outbound": "auto",
        "rule_set": "global-rules"
      },
      {
        "action": "resolve"
      },
      {
        "ip_is_private": true,
        "outbound": "direct",
        "rule_set": [
          "geosite-cn",
          "geoip-cn"
        ]
      },
      {
        "outbound": "direct",
        "override_address": "<<find-ip()>>",
        "rule_set": "geoip-cloudflare"
      }
    ]
  }
}
#+end_src

*** proxy-rules
:PROPERTIES:
:CUSTOM_ID: 71dde8a4-cea2-4a9d-8e22-9e7d7fbb85f7
:END:
#+begin_src json :tangle (zr-org-by-tangle-dir "500-global-rules.json")
<<gen-gloabl-rules()>>
#+end_src

#+name: gen-gloabl-rules
#+begin_src elisp
(let ((raw (multisession-value zr-net-proxy-rules-hash))
      suffix)
  (maphash (lambda (k v) (push k suffix)) raw)
  (json-serialize
   `((route . (rule_set [((tag . "global-rules")
                          (rules . [((domain_suffix . ,(vconcat suffix)))]))])))))
#+end_src

*** tun
:PROPERTIES:
:tangle-dir: _tangle/client/tun
:END:

**** android
:PROPERTIES:
:CUSTOM_ID: 2970e9bb-61e8-4eb3-bc19-233858560385
:END:
#+name: android-tun
#+begin_src json :tangle (if (eq system-type 'android) (zr-org-by-tangle-dir "_500-android.json") "no") :mkdirp t
{
  "inbounds": [
    {
      "address": "172.19.0.1/30",
      "auto_route": true,
      "include_package": [
        "com.arlosoft.macrodroid",
        "com.fooview.android.fooview",
        "InfinityLoop1309.NewPipeEnhanced"
      ],
      "platform": {
        "http_proxy": {
          "enabled": true,
          "server": "127.0.0.1",
          "server_port": 10805
        }
      },
      "strict_route": true,
      "type": "tun"
    }
  ]
}
#+end_src

** server
:PROPERTIES:
:tangle-dir: _tangle/server
:CUSTOM_ID: b85ab91b-1175-4b51-9f3c-f37a0b589979
:END:

#+header: :var cf_token=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "cf")) :api-token)) 1 -1)
#+header: :var hy_masq=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "hy")) :masq)) 1 -1)
#+header: :var hy_email=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "hy")) :email)) 1 -1)
#+header: :var hy_user_name=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "hy")) :user-name)) 1 -1)
#+header: :var vl_priv_key=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "vl")) :priv-key)) 1 -1)
#+header: :var vl_user_name=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "vl")) :user-name)) 1 -1)
#+header: :var any_email=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "any")) :email)) 1 -1)
#+name: server-config
#+begin_src json :tangle (zr-org-by-tangle-dir "_500-main.json") :mkdirp t
{
  "inbounds": [
    {
      "down_mbps": 500,
      "listen": "::",
      "listen_port": 30104,
      "masquerade": "$hy_masq",
      "obfs": {
        "password": "$hy_obfs_pass",
        "type": "salamander"
      },
      "tls": {
        "acme": {
          "dns01_challenge": {
            "api_token": "$cf_token",
            "provider": "cloudflare"
          },
          "domain": "$hy_host",
          "email": "$hy_email"
        },
        "alpn": [
          "h3"
        ],
        "enabled": true,
        "server_name": "$hy_host"
      },
      "type": "hysteria2",
      "up_mbps": 500,
      "users": [
        {
          "name": "$hy_user_name",
          "password": "$hy_user_pass"
        }
      ]
    },
    {
      "listen": "::",
      "listen_port": 38199,
      "tag": "vless-vision-reality",
      "tls": {
        "enabled": true,
        "reality": {
          "enabled": true,
          "handshake": {
            "server": "$vl_host",
            "server_port": 443
          },
          "private_key": "$vl_priv_key",
          "short_id": [
            "$vl_short_id"
          ]
        },
        "server_name": "$vl_host"
      },
      "type": "vless",
      "users": [
        {
          "flow": "xtls-rprx-vision",
          "name": "$vl_user_name",
          "uuid": "$vl_user_uuid"
        }
      ]
    },
    {
      "listen": "::",
      "listen_port": 39833,
      "tls": {
        "acme": {
          "dns01_challenge": {
            "api_token": "$cf_token",
            "provider": "cloudflare"
          },
          "domain": "$any_host",
          "email": "$any_email"
        },
        "enabled": true,
        "server_name": "$any_host"
      },
      "type": "anytls",
      "users": [
        {
          "password": "$any_pass"
        }
      ]
    }
  ],
  "log": {
    "level": "warn"
  },
  "outbounds": [
    {
      "type": "direct"
    }
  ]
}
#+end_src

* helper
#+name: find-ip
#+begin_src elisp
(let* ((result-dir "../cloudflarest/_results/")
       (results (directory-files result-dir t "^[^.]"))
       (result "104.17.133.211"))
  (when results
    (let ((latest (car (last results))))
      (with-temp-buffer
        (insert-file-contents latest)
        (goto-char (point-min))
        (forward-line)
        (let ((pos (point)))
          (search-forward "," (pos-eol))
          (setq result (buffer-substring pos (1- (point))))))))
  result)
#+end_src
