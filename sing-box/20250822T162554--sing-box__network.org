#+title:      sing-box
#+date:       [2025-08-22 Fri 16:25]
#+filetags:   :network:
#+identifier: 20250822T162554

* tangle
#+begin_src elisp
(zr-org-babel-json-format "client-config")
(zr-org-babel-json-format "server-config")
(let ((zr-local-pls (plstore-open "sing-box.pls")))
  (org-babel-tangle)
  (plstore-close zr-local-pls))
#+end_src

* config
:PROPERTIES:
:CUSTOM_ID: 3aeea361-850d-4cc8-b292-065568c194d3
:header-args:json: :var hy_obfs_pass=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "hy")) :obfs-pass)) 1 -1)
:header-args:json+: :var hy_user_name=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "hy")) :user-name)) 1 -1)
:header-args:json+: :var hy_user_pass=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "hy")) :user-pass)) 1 -1)
:header-args:json+: :var hy_host=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "hy")) :host)) 1 -1)
:END:

** client
:PROPERTIES:
:tangle-dir: _tangle/client
:CUSTOM_ID: 4acfcf10-2bef-4815-af7a-fd5f0271c77f
:END:

#+header: :var hy_ip=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "hy")) :ip)) 1 -1)
#+name: client-config
#+begin_src json :tangle (zr-org-by-tangle-dir "config.json") :mkdirp t
{
  "dns": {
    "servers": [
      {
        "server": "8.8.8.8",
        "tag": "google",
        "type": "tls"
      },
      {
        "server": "223.5.5.5",
        "tag": "local",
        "type": "udp"
      }
    ],
    "strategy": "ipv4_only"
  },
  "inbounds": [
    {
      "listen_port": 10805,
      "set_system_proxy": false,
      "tag": "mixed-in",
      "type": "mixed"
    }
  ],
  "outbounds": [
    {
      "tag": "direct",
      "type": "direct"
    },
    {
      "obfs": {
        "password": "$hy_obfs_pass",
        "type": "salamander"
      },
      "password": "$hy_user_pass",
      "server": "$hy_ip",
      "server_port": 30104,
      "tag": "hy",
      "tls": {
        "enabled": true,
        "server_name": "$hy_host"
      },
      "type": "hysteria2"
    },
    {
      "server": "127.0.0.1",
      "server_port": 10808,
      "tag": "trojan-go",
      "type": "socks",
      "version": "5"
    }
  ],
  "route": {
    "auto_detect_interface": true,
    "default_domain_resolver": {
      "client_subnet": "8.8.8.8",
      "rewrite_ttl": 60,
      "server": "local"
    },
    "rule_set": [
      {
        "download_detour": "hy",
        "format": "binary",
        "tag": "geoip-cn",
        "type": "remote",
        "url": "https://raw.githubusercontent.com/SagerNet/sing-geoip/rule-set/geoip-cn.srs"
      },
      {
        "download_detour": "direct",
        "format": "binary",
        "tag": "geosite-cn",
        "type": "remote",
        "url": "https://testingcf.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@sing/geo/geosite/cn.srs"
      },
      {
        "download_detour": "hy",
        "format": "binary",
        "tag": "geosite-!cn",
        "type": "remote",
        "url": "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-geolocation-!cn.srs"
      },
      {
        "download_detour": "trojan-go",
        "format": "binary",
        "tag": "geoip-cloudflare",
        "type": "remote",
        "update_interval": "7d",
        "url": "https://raw.githubusercontent.com/Chocolate4U/Iran-sing-box-rules/rule-set/geoip-cloudflare.srs"
      },
      {
        "download_detour": "trojan-go",
        "format": "binary",
        "tag": "geosite-cloudflare",
        "type": "remote",
        "update_interval": "7d",
        "url": "https://raw.githubusercontent.com/Chocolate4U/Iran-sing-box-rules/rule-set/geosite-cloudflare.srs"
      }
    ],
    "rules": [
      {
        "action": "route-options",
        "override_address": "162.159.138.33",
        "rule_set": [
          "geoip-cloudflare",
          "geosite-cloudflare"
        ]
      },
      {
        "outbound": "hy",
        "rule_set": [
          "geosite-!cn",
          "geoip-!cn"
        ]
      },
      {
        "outbound": "direct",
        "rule_set": [
          "geosite-cn",
          "geoip-cn"
        ]
      }
    ]
  }
}
#+end_src

** server
:PROPERTIES:
:tangle-dir: _tangle/server
:CUSTOM_ID: b85ab91b-1175-4b51-9f3c-f37a0b589979
:END:

#+header: :var cf_token=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "cf")) :api-token)) 1 -1)
#+header: :var hy_masq=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "hy")) :masq)) 1 -1)
#+header: :var hy_email=(substring (json-serialize (plist-get (cdr (plstore-get zr-local-pls "hy")) :email)) 1 -1)
#+name: server-config
#+begin_src json :tangle (zr-org-by-tangle-dir "config.json") :mkdirp t
{
  "inbounds": [
    {
      "down_mbps": 500,
      "listen": "::",
      "listen_port": 30104,
      "masquerade": "$hy_masq",
      "obfs": {
        "password": "$hy_obfs_pass",
        "type": "salamander"
      },
      "tls": {
        "acme": {
          "dns01_challenge": {
            "api_token": "$cf_token",
            "provider": "cloudflare"
          },
          "domain": "$hy_host",
          "email": "$hy_email"
        },
        "enabled": true,
        "server_name": "$hy_host"
      },
      "type": "hysteria2",
      "up_mbps": 500,
      "users": [
        {
          "name": "$hy_user_name",
          "password": "$hy_user_pass"
        }
      ]
    }
  ],
  "log": {
    "level": "info"
  },
  "outbounds": [
    {
      "type": "direct"
    }
  ]
}
#+end_src
