#+title:      litellm
#+date:       [2025-12-10 Wed 20:18]
#+filetags:   :server:
#+identifier: 20251210T201813

* tangle
#+begin_src elisp
(let ((zr-org-tangle-default-dir
       (if zr-sys-linux-p
           "/etc/litellm/"
         "_tangle"))
      (coding-system-for-write 'utf-8))
  (org-babel-tangle))
#+end_src

* config
#+header: :tangle-mode o604
#+begin_src json :comments no :mkdirp t :tangle (zr-org-by-tangle-dir "config.json")
<<gen-config()>>
#+end_src

#+header: :var models=models-tbl[] :colnames no
#+name: gen-config
#+begin_src elisp
(cl-letf (((symbol-function 'format-models)
           (lambda (name params)
             (let ((models (ensure-list (or (plist-get params :model) name)))
                   (ant-headers '((anthropic-beta . "claude-code-20250219,interleaved-thinking-2025-05-14,fine-grained-tool-streaming-2025-05-14")
                                  (anthropic-dangerous-direct-browser-access . "true")
                                  (anthropic-version . "2023-06-01")
                                  (user-agent . "claude-cli/2.0.61 (external, cli)")
                                  (x-app . "cli")))
                   (k-key :api_key_o)
                   (k-base :api_base_o)
                   result)
               (mapc
                (lambda (model)
                  (let ((this-model (copy-sequence params)))
                    (pcase model
                      ("t" (plist-put this-model :model (concat "openai/" name)))
                      ((rx bos "cx/")
                       (let ((model (if (string= "cx/t" model)
                                        (concat "openai/" name)
                                      (replace-regexp-in-string "^cx/" "openai/" model))))
                         (plist-put this-model :model model)
                         (setq k-key :api_key_cx)))
                      ((rx bos "ant/")
                       (let ((model (if (string= "ant/t" model)
                                        (concat "anthropic/" name)
                                      (replace-regexp-in-string "^ant/" "anthropic/" model))))
                         (plist-put this-model :extra_headers
                                    (append (plist-get this-model :extra_headers)
                                            ant-headers))
                         (plist-put this-model :model model)
                         (setq k-key :api_key_a
                               k-base :api_base_a)))
                      ((rx bos "gmn/")
                       (let ((model (if (string= "gmn/t" model)
                                        (concat "gemini/" name)
                                      (replace-regexp-in-string "^gmn/" "" model))))
                         (plist-put this-model :model model)
                         (setq k-key :api_key_g
                               k-base :api_base_g)))
                      (_ (plist-put this-model :model (concat "openai/" model))))
                    (mapc
                     (lambda (base)
                       (let ((new-base (append `( :api_base ,base)
                                               this-model)))
                         (mapc
                          (lambda (key)
                            (let ((new (append `( :api_key ,key
                                                  :api_key_a :null
                                                  :api_key_o :null
                                                  :api_key_cx :null
                                                  :api_base_a :null
                                                  :api_base_o :null)
                                               new-base)))
                              (when (equal k-key :api_key_cx)
                                (plist-put new :tags (vconcat ["cx"] (plist-get new :tags))))
                              (push `((model_name . ,name)
                                      (litellm_params . ,new))
                                    result)))
                          (ensure-list (or (plist-get params k-key)
                                           (when (eq k-key :api_key_cx)
                                             (plist-get params :api_key_o))
                                           (plist-get params :api_key))))))
                     (ensure-list (or (plist-get this-model k-base)
                                      (plist-get this-model :api_base))))))
                (mapcar (lambda (model) (format model name)) models))
               result)))
          ((symbol-function 'all-string-p)
           (lambda (list) (cl-every #'stringp list))))
  (let* ((zr-local-pls (plstore-open (expand-file-name "litellm.pls" zr-secrets-dir)))
         (secret (plstore-find zr-local-pls '(:provider (t))))
         (public '(("iflow" . ( :api_base "https://apis.iflow.cn/v1"
                                :weight 5))
                   ("modelscope" . ( :api_base "https://api-inference.modelscope.cn/v1"
                                     :weight 2))
                   ("snow" . ( :extra_headers ((x-snow . "true")
                                               (user-agent . "node"))
                               :tags ("snow")))
                   ("ouyangqiqi" . ( :tags ("tavern")))
                   ("bohe" . ( :tags ("tavern")))
                   ("sc0152" . ( :tags ("tavern")))
                   ("88code" . ( :tags ("cx")))
                   ;; ("zhongruan" . ( :tags ("cx")))
                   ;; ("api" . ( :tags ("test")))
                   ("HenryXiaoYang" . (:tags ("cc")))
                   ("Sanyela" . ( :weight 8
                                  :tags ("cc")))
                   ("anyrouter" . ( :tags ("cc")))
                   ("jason_wong1" . ( :weight 6
                                      :tags ("cc")))))
         (common '( :additional_drop_params ["api_key_a"
                                             "api_key_o"
                                             "api_base_a"
                                             "api_base_o"
                                             ;; "provider"
                                             ] ))
         (col (car models))
         (model-map (cdr models))
         (providers (cdr col))
         (litellm (cdr (plstore-get zr-local-pls "litellm")))
         (litellm-settings '((drop_params . t)
                             (num_retries . 3)
                             (default_fallbacks . ["glm-4.6"])
                             ;; (turn_off_message_logging . t)
                             (redact_user_api_key_info . t)
                             (callbacks . ["langfuse_otel"])))
         (general-settings `((forward_client_headers_to_llm_api . :false)
                             (disable_master_key_return . t)
                             ;; (master_key . ,(plist-get litellm :master))
                             ;; (database_url . "")
                             (allow_requests_on_db_unavailable . t)
                             (background_health_checks . :false)))
         (router-settings '((allowed_fails . 3)
                            (cooldown_time . 30)
                            (enable_tag_filtering . t)
                            (fallbacks . [((gemini-3-pro . ["gemini-2.5-pro"]))
                                          ((claude-opus-4-5-20251101 . ["claude-opus-4-5"]))
                                          ((claude-sonnet-4-5-20250929 . ["claude-sonnet-4-5" "claude-4.5-sonnet"]))
                                          ((claude-sonnet-4-20250514 . ["claude-4-sonnet"]))
                                          ((claude-3-5-haiku-20241022 . ["claude-haiku-4-5-20251001"]))])))
         model-list)
    (seq-do-indexed
     (lambda (provider i)
       (when-let* ((params (append (alist-get provider secret nil nil #'string=)
                                   (alist-get provider public nil nil #'string=)
                                   common)))
         (dolist (model model-map)
           (let ((name (car model))
                 (new (copy-sequence params))
                 (extra (zr-org-string-maybe-eval (nth (1+ i) model))))
             (if-let* ((tags (plist-get new :tags)))
                 (plist-put new :tags (vconcat `(,provider) tags))
               (plist-put new :tags (vector "general" provider)))
             (plist-put new :provider provider)
             (pcase extra
               ("")
               ((or (pred stringp)
                    (pred all-string-p))
                (plist-put new :model extra)
                (push (format-models name new) model-list))
               (_ (push (format-models name (append extra new)) model-list)))))))
     providers)
    (json-serialize `((model_list . ,(apply #'vconcat model-list))
                      (litellm_settings . ,litellm-settings)
                      (general_settings . ,general-settings)
                      (router_settings . ,router-settings)))))
#+end_src

* models
#+name: models-tbl
| name                          | WCyrus | api | Sanyela | zhongruan | pangil            | kkkyyx     | dabuliu           | bohe                  | HenryXiaoYang | bytebender                   | jason_wong1 | anyrouter | huan                 | snow | 88code | ouyangqiqi              | modelscope                          | sc0152                                    | linuxdo |
|-------------------------------+--------+-----+---------+-----------+-------------------+------------+-------------------+-----------------------+---------------+------------------------------+-------------+-----------+----------------------+------+--------+-------------------------+-------------------------------------+-------------------------------------------+---------|
| glm-4.6                       |        | t   |         |           |                   |            |                   |                       |               |                              |             |           |                      |      |        |                         |                                     |                                           |         |
| claude-opus-4-5               |        |     |         |           |                   |            |                   | %s-thinking           |               | claude-4.5-opus              |             |           |                      |      |        |                         |                                     |                                           | t       |
| claude-opus-4-5-20251101      | t      |     | ant/t   | ant/t     | t                 |            |                   |                       | ant/t         |                              | ant/t       | ant/t     |                      |      |        |                         |                                     |                                           | t       |
| claude-sonnet-4-5             |        |     |         |           | '("t" "%s-think") |            |                   | t                     |               | t                            |             |           |                      |      |        | t                       |                                     | claude-sonnet-4.5 [渠道id:33][輸出3k上限] | t       |
| claude-4.5-sonnet             |        |     |         |           | '("t" "%s-think") | cursor2-%s | '("t" "%s-think") |                       |               | '("t" "%s-official-reverse") |             |           |                      |      |        |                         |                                     |                                           | t       |
| claude-sonnet-4-5-20250929    | t      |     | ant/t   | ant/t     | t                 | cursor2-%s |                   |                       | ant/t         | t                            | ant/t       | ant/t     |                      |      |        |                         |                                     |                                           | t       |
| claude-4-sonnet               |        |     |         |           | '("t" "%s-think") | cursor2-%s | '("t" "%s-think") |                       |               | '("t" "ant/%s-cc")           |             |           |                      |      |        | t                       |                                     |                                           | t       |
| claude-sonnet-4-20250514      |        |     | ant/t   | ant/t     |                   |            |                   |                       | ant/t         |                              | ant/t       | ant/t     |                      |      |        |                         |                                     |                                           | t       |
| claude-haiku-4-5-20251001     | t      |     | ant/t   | ant/t     | t                 |            |                   |                       | ant/t         |                              | ant/t       | ant/t     |                      |      |        |                         |                                     |                                           | t       |
| claude-3-5-haiku-20241022     |        |     |         | ant/t     |                   |            |                   |                       |               |                              | ant/t       | ant/t     |                      |      |        |                         |                                     |                                           | t       |
| gpt-5                         |        |     |         |           |                   | cx/t       |                   |                       |               |                              |             |           |                      | t    |        |                         |                                     |                                           | t       |
| gpt-5-codex                   |        |     |         |           |                   | cx/t       |                   |                       |               |                              |             | ant/t     |                      | t    | t      |                         |                                     |                                           | t       |
| gpt-5.1                       |        |     |         |           |                   | cx/t       |                   |                       |               | t                            |             |           |                      | t    | t      |                         |                                     |                                           | t       |
| gpt-5.1-codex                 |        |     |         |           | t                 | cx/t       |                   |                       |               |                              |             |           |                      | t    | t      |                         |                                     |                                           |         |
| gpt-5.1-codex-max             |        |     |         |           |                   | cx/t       |                   |                       |               |                              |             |           |                      | t    | t      |                         |                                     |                                           | t       |
| gpt-5.2                       |        |     |         |           |                   |            |                   |                       |               |                              |             |           |                      |      |        |                         |                                     |                                           |         |
| gemini-2.5-flash              |        |     |         |           |                   |            |                   |                       |               |                              |             |           |                      |      |        |                         |                                     |                                           |         |
| gemini-2.5-pro                |        |     |         |           | t                 |            |                   | %s-1m                 |               | t                            |             | ant/t     |                      |      |        | '("t" "hyb-Optimal/%s") |                                     |                                           | t       |
| gemini-3-pro                  |        |     |         |           | %s-coding-32k     |            |                   | '("%s-low" "%s-high") |               | %s-preview                   |             |           |                      |      |        | gemini-pro-latest       |                                     |                                           | t       |
| grok-4.1                      |        |     |         |           |                   |            |                   |                       |               | %s-thinking                  |             |           | '("t" "%s-thinking") |      |        | '("t" "%s-thinking")    |                                     |                                           | t       |
| qwen3-coder-plus              |        | t   |         |           |                   |            |                   |                       |               |                              |             |           |                      |      |        |                         | Qwen/Qwen3-Coder-480B-A35B-Instruct |                                           |         |
| qwen3-max                     |        | t   |         |           |                   |            |                   |                       |               |                              |             |           |                      |      |        |                         |                                     |                                           |         |
| qwen3-vl-plus                 |        | t   |         |           |                   |            |                   |                       |               |                              |             |           |                      |      |        |                         | Qwen/Qwen3-VL-235B-A22B-Instruct    |                                           |         |
| kimi-k2-0905                  |        | t   |         |           |                   |            |                   |                       |               |                              |             |           |                      |      |        |                         |                                     |                                           |         |
| kimi-k2                       |        | t   |         |           |                   |            |                   |                       |               |                              |             |           |                      |      |        |                         |                                     |                                           |         |
| deepseek-v3.2                 |        | t   |         |           |                   |            |                   |                       |               |                              |             |           |                      |      |        |                         | deepseek-ai/DeepSeek-V3.2           |                                           |         |
| deepseek-r1                   |        | t   |         |           |                   |            |                   |                       |               |                              |             |           |                      |      |        |                         | deepseek-ai/DeepSeek-R1-0528        |                                           |         |
| deepseek-v3                   |        | t   |         |           |                   |            |                   |                       |               |                              |             |           |                      |      |        |                         |                                     |                                           |         |
| qwen3-235b-a22b-thinking-2507 |        | t   |         |           |                   |            |                   |                       |               |                              |             |           |                      |      |        |                         | Qwen/Qwen3-235B-A22B-Thinking-2507  |                                           |         |
| qwen3-235b-a22b-instruct      |        | t   |         |           |                   |            |                   |                       |               |                              |             |           |                      |      |        |                         | Qwen/Qwen3-235B-A22B-Instruct-2507  |                                           |         |
| minimax-m2                    |        | t   |         |           |                   |            |                   |                       |               |                              |             |           |                      |      |        |                         |                                     |                                           |         |
| z-image-turbo                 |        |     |         |           |                   |            |                   |                       |               |                              |             |           |                      |      |        |                         | Tongyi-MAI/Z-Image-Turbo            |                                           |         |
| glm-4.6v                      |        |     |         |           |                   |            |                   |                       |               |                              |             |           |                      |      |        |                         | ZhipuAI/GLM-4.6V                    |                                           |         |

* knock knock
#+begin_src elisp
(let* ((zr-local-pls (plstore-open (expand-file-name "litellm.pls" zr-secrets-dir)))
       (urls (plist-get (cdr (plstore-get zr-local-pls "knock")) :urls)))
  (dolist (url (append '("https://platform.iflow.cn/profile?tab=apiKey")
                       urls))
    (browse-url url)))
#+end_src

# Local Variables:
# truncate-lines: t
# End:
